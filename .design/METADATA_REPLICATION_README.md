# RustFS å…ƒæ•°æ®ä¸­å¿ƒå¤šå‰¯æœ¬æ”¯æŒ - å¿«é€Ÿå¯¼èˆª

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-24  
**çŠ¶æ€**: Design Proposal

---

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬ç›®å½•åŒ…å« RustFS å…ƒæ•°æ®ä¸­å¿ƒå¤šå‰¯æœ¬æ¶æ„çš„å®Œæ•´è®¾è®¡æ–‡æ¡£ã€‚

### æ ¸å¿ƒæ–‡æ¡£

| æ–‡æ¡£åç§°                                   | å¤§å°   | å†…å®¹æ¦‚è¦          | é€‚ç”¨äººç¾¤    |
|----------------------------------------|------|---------------|---------|
| **METADATA_REPLICATION_DESIGN.md**     | 45KB | å®Œæ•´çš„å¤šå‰¯æœ¬æ¶æ„è®¾è®¡    | æ¶æ„å¸ˆã€å¼€å‘è€… |
| DUAL_METADATA_CENTER_DESIGN.md         | 52KB | åŒå…ƒæ•°æ®ä¸­å¿ƒè®¾è®¡ï¼ˆå•èŠ‚ç‚¹ï¼‰ | æ¶æ„å¸ˆ     |
| MULTI_NODE_REPLICATION_ARCHITECTURE.md | 43KB | æ•°æ®å¯¹è±¡å¤šå‰¯æœ¬æ¶æ„     | è¿ç»´ã€å¼€å‘è€…  |

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### æˆ‘æƒ³äº†è§£å…ƒæ•°æ®å¤šå‰¯æœ¬

**æ¨èé˜…è¯»é¡ºåº**:

1. **æœ¬æ–‡æ¡£** (5 åˆ†é’Ÿ) - å¿«é€Ÿäº†è§£æ¦‚å†µ
2. **METADATA_REPLICATION_DESIGN.md** (60 åˆ†é’Ÿ) - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ
    - æ‰§è¡Œæ‘˜è¦ï¼šäº†è§£æ ¸å¿ƒä»·å€¼
    - æ¶æ„æ¦‚è¿°ï¼šç†è§£æ•´ä½“è®¾è®¡
    - å¤šå‰¯æœ¬æ¶æ„ï¼šæ·±å…¥æŠ€æœ¯ç»†èŠ‚
    - å®ç°æ–¹æ¡ˆï¼šäº†è§£å¦‚ä½•å®æ–½

### æˆ‘æƒ³å¯¹æ¯”ä¸åŒå‰¯æœ¬æ–¹æ¡ˆ

| æ–¹æ¡ˆ      | æ•°æ®ç±»å‹     | å‰¯æœ¬æœºåˆ¶    | ä¸€è‡´æ€§   | æ–‡æ¡£                                     |
|---------|----------|---------|-------|----------------------------------------|
| å…ƒæ•°æ®å¤šå‰¯æœ¬  | å…ƒæ•°æ® (KV) | Raft å…±è¯† | å¼ºä¸€è‡´æ€§  | METADATA_REPLICATION_DESIGN.md         |
| æ•°æ®å¯¹è±¡å¤šå‰¯æœ¬ | å¯¹è±¡æ•°æ®     | æ“¦é™¤ç¼–ç     | æœ€ç»ˆä¸€è‡´æ€§ | MULTI_NODE_REPLICATION_ARCHITECTURE.md |
| å•èŠ‚ç‚¹å…ƒæ•°æ®  | å…ƒæ•°æ® (KV) | æ—        | æœ¬åœ°ä¸€è‡´æ€§ | DUAL_METADATA_CENTER_DESIGN.md         |

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### å½“å‰æ¶æ„ï¼ˆå•èŠ‚ç‚¹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        LocalMetadataEngine          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚SurrealKV â”‚  â”‚    Ferntree     â”‚ â”‚
â”‚  â”‚  (ACID)  â”‚  â”‚   (B+ Tree)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚         SurrealMX               â”‚
â”‚  â”‚      (Storage Manager)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é™åˆ¶**:

- âŒ å•ç‚¹æ•…éšœ
- âŒ æ— æ•°æ®å†—ä½™
- âŒ æ— æ³•æ‰©å±•è¯»èƒ½åŠ›

### ç›®æ ‡æ¶æ„ï¼ˆå¤šå‰¯æœ¬ï¼‰

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  S3 Application API  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ ReplicatedMetadata   â”‚
                â”‚      Engine          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Node 1 â”‚       â”‚  Node 2  â”‚     â”‚  Node 3  â”‚
    â”‚(Leader)â”‚â—„â”€â”€â”€â”€â”€â–¶â”‚(Follower)â”‚â—„â”€â”€â”€â–¶â”‚(Follower)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
     LocalMeta         LocalMeta         LocalMeta
     Engine            Engine            Engine
```

**ä¼˜åŠ¿**:

- âœ… é«˜å¯ç”¨ï¼š3 å‰¯æœ¬å®¹å¿ 1 èŠ‚ç‚¹æ•…éšœ
- âœ… æ•°æ®å®‰å…¨ï¼šå¤šèŠ‚ç‚¹å†—ä½™
- âœ… è¯»æ‰©å±•ï¼šå‰¯æœ¬åˆ†æ‹…è¯»è´Ÿè½½
- âœ… å¼ºä¸€è‡´æ€§ï¼šRaft ä¿è¯

---

## æ ¸å¿ƒæŠ€æœ¯

### 1. Raft å…±è¯†åè®®

**ä¸ºä»€ä¹ˆé€‰æ‹© Raftï¼Ÿ**

- âœ… å¼ºä¸€è‡´æ€§ä¿è¯
- âœ… æˆç†Ÿç¨³å®šï¼ˆetcdã€TiKV éƒ½ä½¿ç”¨ï¼‰
- âœ… Rust ç”Ÿæ€å®Œå–„ (`raft-rs`)
- âœ… æ˜“äºç†è§£å’Œè°ƒè¯•

**å·¥ä½œåŸç†**:

```
Client Write
    â†“
Leader (Node 1)
    â”‚
    â”‚ 1. Append to log
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚                â”‚
    â–¼                   â–¼                â–¼
Node 1            Node 2           Node 3
    â”‚                   â”‚                â”‚
    â”‚ 2. Replicate log  â”‚                â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                   â”‚                â”‚
    â”‚ 3. Wait for majority (2/3)         â”‚
    â”‚                   â”‚                â”‚
    â”‚ 4. Commit & Apply â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                   â”‚                â”‚
    â–¼                   â–¼                â–¼
 SurrealKV         SurrealKV        SurrealKV
```

### 2. è¯»å†™æµç¨‹

#### å†™å…¥æµç¨‹

```rust
async fn put_object(...) -> Result<ObjectInfo> {
    // 1. åºåˆ—åŒ–æ“ä½œ
    let op = MetadataOperation::new(...);

    // 2. Raft ææ¡ˆ
    raft_node.propose(op).await?;

    // 3. ç­‰å¾…å¤šæ•°ç¡®è®¤
    raft_node.wait_committed(op.op_id).await?;

    // 4. åº”ç”¨åˆ°æœ¬åœ°å¼•æ“
    local_engine.put_object(...).await
}
```

**å»¶è¿Ÿ**: ~10ms (åŒ…æ‹¬ç½‘ç»œ RTT å’Œå…±è¯†)

#### è¯»å–æµç¨‹

```rust
async fn get_object(...) -> Result<ObjectInfo> {
    match read_consistency {
        // ä»ä»»æ„å‰¯æœ¬è¯»ï¼ˆæœ€å¿«ï¼‰
        Eventual => local_engine.get_object(...).await,

        // ä» Leader è¯»ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
        Linearizable => {
            if is_leader() {
                local_engine.get_object(...).await
            } else {
                forward_to_leader(...).await
            }
        }
    }
}
```

**å»¶è¿Ÿ**: ~1ms (æœ¬åœ°è¯»å–ï¼Œæ— å…±è¯†)

### 3. æ•…éšœå¤„ç†

#### Leader æ•…éšœ

```
Before:
  Leader (Node 1) âœ“ â†’ Follower (Node 2) âœ“
                  â””â”€â†’ Follower (Node 3) âœ“

Leader Crashes:
  Leader (Node 1) âœ—

Election (< 30s):
  1. Node 2/3 timeout â†’ Candidate
  2. Node 2 wins election
  3. Node 2 becomes new Leader

After:
  Leader (Node 2) âœ“ â†’ Follower (Node 1) âœ—
                  â””â”€â†’ Follower (Node 3) âœ“

Recovery:
  1. Node 1 restarts
  2. Catches up logs from Node 2
  3. Becomes Follower
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡        | å•èŠ‚ç‚¹        | 3 å‰¯æœ¬       | è¯´æ˜             |
|-----------|------------|------------|----------------|
| å†™å»¶è¿Ÿ (P99) | ~5ms       | ~10ms      | å¢åŠ  Raft å…±è¯†å¼€é”€   |
| è¯»å»¶è¿Ÿ (P99) | ~1ms       | ~1ms       | æœ¬åœ°è¯»å–ï¼Œæ— å˜åŒ–       |
| å†™ååé‡      | 50K ops/s  | 40K ops/s  | ç½‘ç»œå’Œå…±è¯†å¼€é”€        |
| è¯»ååé‡      | 100K ops/s | 300K ops/s | 3x æå‡ï¼ˆå‰¯æœ¬åˆ†æ‹…ï¼‰    |
| å¯ç”¨æ€§       | 0 å®¹é”™       | 1 èŠ‚ç‚¹å®¹é”™     | 99.9% â†’ 99.99% |
| æ•°æ®æŒä¹…æ€§     | å•å‰¯æœ¬        | 3 å‰¯æœ¬       | 3x æ•°æ®å®‰å…¨        |

---

## å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¡†æ¶ (2 å‘¨)

- âœ… Raft é›†æˆ
- âœ… åŸºæœ¬æ—¥å¿—å¤åˆ¶
- âœ… Leader é€‰ä¸¾
- âœ… å•å…ƒæµ‹è¯•

### Phase 2: å†™å…¥å¤åˆ¶ (2 å‘¨)

- âœ… æ“ä½œåºåˆ—åŒ–
- âœ… Raft ææ¡ˆå’Œæäº¤
- âœ… åº”ç”¨åˆ°æœ¬åœ°å¼•æ“
- âœ… é›†æˆæµ‹è¯•

### Phase 3: æ•…éšœè½¬ç§» (1 å‘¨)

- âœ… å¥åº·ç›‘æ§
- âœ… è‡ªåŠ¨é€‰ä¸»
- âœ… Leader è½¬å‘
- âœ… æ•…éšœæ¼”ç»ƒ

### Phase 4: å¿«ç…§ä¸ä¼˜åŒ– (2 å‘¨)

- âœ… æ—¥å¿—å‹ç¼©
- âœ… å¿«ç…§ä¼ è¾“
- âœ… æ‰¹é‡å†™å…¥
- âœ… æ€§èƒ½è°ƒä¼˜

### Phase 5: ç”Ÿäº§åŒ– (1 å‘¨)

- âœ… ç›‘æ§æŒ‡æ ‡
- âœ… å‘Šè­¦é…ç½®
- âœ… è¿ç»´å·¥å…·
- âœ… æ–‡æ¡£å®Œå–„

**æ€»å·¥æœŸ**: 8 å‘¨

---

## é…ç½®ç¤ºä¾‹

```yaml
# metadata-replication.yaml

metadata:
  engine_type: replicated  # "local" for single-node

  replication:
    # Cluster nodes
    nodes:
      - id: 1
        address: "192.168.1.101:7000"
      - id: 2
        address: "192.168.1.102:7000"
      - id: 3
        address: "192.168.1.103:7000"

    # Current node
    node_id: 1

    # Raft settings
    raft:
      election_timeout_ms: 1000
      heartbeat_interval_ms: 100
      max_log_entries: 10000

    # Consistency
    read_consistency: linearizable
```

---

## ç›‘æ§æŒ‡æ ‡

### Prometheus Metrics

```
# Cluster health
rustfs_metadata_replication_leader_id
rustfs_metadata_replication_node_count
rustfs_metadata_replication_healthy_nodes

# Performance
rustfs_metadata_replication_write_latency_seconds
rustfs_metadata_replication_read_latency_seconds
rustfs_metadata_replication_ops_per_second

# Replication lag
rustfs_metadata_replication_lag_entries
rustfs_metadata_replication_lag_time_ms

# Raft state
rustfs_metadata_replication_term
rustfs_metadata_replication_committed_index
rustfs_metadata_replication_applied_index
```

### Grafana Dashboard

å‚è€ƒ `METADATA_REPLICATION_DESIGN.md` ä¸­çš„è¿ç»´ç®¡ç†ç« èŠ‚ã€‚

---

## è¿ç»´å‘½ä»¤

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
rustfs-admin metadata status

# æ·»åŠ èŠ‚ç‚¹
rustfs-admin metadata add-node --id 4 --address 192.168.1.104:7000

# ç§»é™¤èŠ‚ç‚¹
rustfs-admin metadata remove-node --id 4

# è½¬ç§» Leader
rustfs-admin metadata transfer-leadership --to 2

# åˆ›å»ºå¿«ç…§
rustfs-admin metadata snapshot create

# æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
rustfs-admin metadata lag
```

---

## å¸¸è§é—®é¢˜

### Q1: å…ƒæ•°æ®å¤šå‰¯æœ¬å’Œæ•°æ®å¯¹è±¡å¤šå‰¯æœ¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**:

| ç‰¹æ€§   | å…ƒæ•°æ®å¤šå‰¯æœ¬         | æ•°æ®å¯¹è±¡å¤šå‰¯æœ¬        |
|------|----------------|----------------|
| æ•°æ®ç±»å‹ | å…ƒæ•°æ® (KB çº§)     | å¯¹è±¡æ•°æ® (MB-GB çº§) |
| å¤åˆ¶æœºåˆ¶ | Raft å…±è¯† (å®Œæ•´å‰¯æœ¬) | æ“¦é™¤ç¼–ç  (åˆ†ç‰‡)      |
| ä¸€è‡´æ€§  | å¼ºä¸€è‡´æ€§           | æœ€ç»ˆä¸€è‡´æ€§          |
| å­˜å‚¨å¼€é”€ | 3x             | 1.5x (8+4)     |
| é€‚ç”¨åœºæ™¯ | å°æ•°æ®ã€é«˜ä¸€è‡´æ€§       | å¤§æ•°æ®ã€é«˜æ•ˆç‡        |

### Q2: ä¸ºä»€ä¹ˆå…ƒæ•°æ®ä¸ç”¨æ“¦é™¤ç¼–ç ï¼Ÿ

**A**: å…ƒæ•°æ®ç‰¹ç‚¹ï¼š

- æ•°æ®é‡å°ï¼ˆKB çº§ï¼‰
- è®¿é—®é¢‘ç¹
- è¦æ±‚å¼ºä¸€è‡´æ€§
- å»¶è¿Ÿæ•æ„Ÿ

æ“¦é™¤ç¼–ç ä¸é€‚åˆï¼š

- ç¼–è§£ç å¼€é”€å¤§äºå­˜å‚¨æ”¶ç›Š
- æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§
- é‡å»ºå»¶è¿Ÿé«˜

### Q3: 3 å‰¯æœ¬ä¼šä¸ä¼šå¤ªå¤šï¼Ÿ

**A**: 3 å‰¯æœ¬æ˜¯è¡Œä¸šæ ‡å‡†ï¼š

- etcd: 3-5 å‰¯æœ¬
- TiKV: 3 å‰¯æœ¬
- Consul: 3-5 å‰¯æœ¬

åŸå› ï¼š

- å®¹å¿ 1 èŠ‚ç‚¹æ•…éšœï¼ˆæœ€å° HAï¼‰
- Raft éœ€è¦å¥‡æ•°èŠ‚ç‚¹
- å­˜å‚¨å¼€é”€å¯æ¥å—ï¼ˆå…ƒæ•°æ®é‡å°ï¼‰

### Q4: å¦‚ä½•ä»å•èŠ‚ç‚¹è¿ç§»åˆ°å¤šå‰¯æœ¬ï¼Ÿ

**A**: å¹³æ»‘è¿ç§»æ­¥éª¤ï¼š

1. éƒ¨ç½² 3 ä¸ªèŠ‚ç‚¹ï¼ˆ1 ä¸ªä»ç°æœ‰å•èŠ‚ç‚¹å‡çº§ï¼‰
2. é…ç½® Raft é›†ç¾¤
3. å¿«ç…§ä¼ è¾“åˆ°æ–°èŠ‚ç‚¹
4. åˆ‡æ¢åˆ° Replicated æ¨¡å¼
5. éªŒè¯æ•°æ®ä¸€è‡´æ€§

è¯¦è§ `METADATA_REPLICATION_DESIGN.md` å®ç°æ–¹æ¡ˆç« èŠ‚ã€‚

---

## ç›¸å…³æ–‡æ¡£

### è®¾è®¡æ–‡æ¡£

- **METADATA_REPLICATION_DESIGN.md** - æœ¬è®¾è®¡çš„è¯¦ç»†æ–‡æ¡£
- DUAL_METADATA_CENTER_DESIGN.md - å•èŠ‚ç‚¹å…ƒæ•°æ®ä¸­å¿ƒè®¾è®¡
- MULTI_NODE_REPLICATION_ARCHITECTURE.md - æ•°æ®å¯¹è±¡å¤šå‰¯æœ¬è®¾è®¡

### å®ç°æŒ‡å—

- TODO: å®ç°æŒ‡å—ï¼ˆå¾…ç¼–å†™ï¼‰
- TODO: è¿ç»´æ‰‹å†Œï¼ˆå¾…ç¼–å†™ï¼‰
- TODO: æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆå¾…ç¼–å†™ï¼‰

---

## è´¡çŒ®æŒ‡å—

å¦‚æœæ‚¨å¯¹æœ¬è®¾è®¡æœ‰å»ºè®®æˆ–å‘ç°é—®é¢˜ï¼š

1. åœ¨ GitHub æäº¤ Issue
2. æ ‡è®°ä¸º `metadata-replication` æ ‡ç­¾
3. æä¾›è¯¦ç»†çš„æè¿°å’Œåœºæ™¯

---

**æœ€åæ›´æ–°**: 2026-02-24  
**ç»´æŠ¤è€…**: RustFS Architecture Team  
**çŠ¶æ€**: Design Proposal

